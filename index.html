<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Button Click Game</title>

<style>
  body { font-family: Arial; display: flex; flex-direction: column; align-items: center; margin: 20px; }
  #info { display: flex; gap: 20px; margin-bottom: 20px; font-size: 20px; }
  #timer.flash { animation: flash 0.5s infinite alternate; }
  @keyframes flash { from { color: red; } to { color: black; } }

  #container { display: flex; flex-wrap: wrap; gap: 10px; max-width: 95vw; justify-content: center; }
  .btn { padding: 16px 24px; font-size: 20px; border: none; cursor: pointer; background: #ddd; border-radius: 6px; }
  .clicked { opacity: 0.5; pointer-events: none; }

  #leaderboard { margin-top: 20px; text-align: center; width: 320px; }
  #scoresList { text-align: left; padding-left: 20px; }

  /* MOBILE */
  body.mobile .btn { flex: 0 0 calc(20% - 10px); padding: 20px; font-size: 22px; }
  body.mobile #container { justify-content: center; }
</style>
</head>
<body>

<div id="info">
  <div>Score: <span id="score">0</span></div>
  <div>Time: <span id="timer">30</span>s</div>
  <button id="restart">Restart</button>
  <button id="resetLeaderboard">Reset Leaderboard</button>
</div>

<div id="container">
  <button class="btn" id="startBtn">Click me!</button>
</div>

<div id="leaderboard">
  <h3>Leaderboard</h3>
  <ol id="scoresList"></ol>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* Detect mobile FIRST */
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
if (isMobile) document.body.classList.add("mobile");

/* Firebase (safe initialization) */
let db = null;
try {
  const firebaseConfig = {
    apiKey: "AIzaSyBPLrSA5oKxw-PqBzrBZJa4u-LKjTmFM3Y",
    authDomain: "button-game-75748.firebaseapp.com",
    projectId: "button-game-75748",
    storageBucket: "button-game-75748.firebasestorage.app",
    messagingSenderId: "1003146862930",
    appId: "1:1003146862930:web:4eef5885db68e4cd541a8b"
  };
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
} catch (e) {
  console.warn("Firebase failed to initialize â€” game continues offline.");
}

async function loadScores() {
  if (!db) return;
  try {
    const snap = await db.collection("scores").orderBy("score", "desc").limit(10).get();
    const list = document.getElementById("scoresList");
    list.innerHTML = "";
    snap.forEach(doc => {
      const d = doc.data();
      list.innerHTML += `<li>${d.name}: ${d.score}</li>`;
    });
  } catch (e) {
    console.warn("Leaderboard load failed");
  }
}

async function saveScore(name, score) {
  if (!db) return;
  try {
    await db.collection("scores").add({ name, score, timestamp: Date.now() });
    loadScores();
  } catch (e) {
    console.warn("Score save failed");
  }
}

/* Game variables */
let timeLeft = 30;
let timerStarted = false;
let score = 0;
let timer = null;

/* DOM */
const container = document.getElementById("container");
const scoreEl = document.getElementById("score");
const timerEl = document.getElementById("timer");

/* Start timer only after first click */
function startTimer() {
  if (timerStarted) return;
  timerStarted = true;

  timer = setInterval(() => {
    timeLeft--;
    timerEl.textContent = timeLeft;

    if (timeLeft <= 3) timerEl.classList.add("flash");
    if (timeLeft === 0) endGame();

  }, 1000);
}

function endGame() {
  clearInterval(timer);
  document.querySelectorAll(".btn").forEach(b => b.disabled = true);

  const name = prompt("Game over! Enter name:");
  saveScore(name || "Anonymous", score);
}

function addButton(isBonus = false, isTrap = false) {
  const btn = document.createElement("button");
  btn.className = "btn";

  if (isBonus) {
    btn.textContent = "+3 BONUS!";
    btn.style.background = "#ffcc00";
    btn.dataset.bonus = "1";
  } else if (isTrap) {
    const minus = Math.floor(Math.random() * 3) + 1;
    btn.textContent = `ðŸ’£ -${minus}`;
    btn.style.background = "#ff4444";
    btn.dataset.trap = minus;
  } else {
    btn.textContent = "Click me!";
  }

  container.appendChild(btn);

  if (isMobile) btn.scrollIntoView({ behavior: "smooth", block: "nearest" });
}

/* Click handler */
container.addEventListener("click", e => {
  if (!e.target.classList.contains("btn")) return;

  startTimer();

  const btn = e.target;
  if (btn.classList.contains("clicked")) return;
  btn.classList.add("clicked");

  // Score update
  if (btn.dataset.bonus) score += 3;
  else if (btn.dataset.trap) score -= parseInt(btn.dataset.trap);
  else score++;

  scoreEl.textContent = score;

  // Generate next button:
  const r = Math.random();
  if (r < 0.20) {
    addButton(false, true);           // trap
    addButton(Math.random() < 0.2);   // extra safe button
  } else if (r < 0.35) {
    addButton(true, false);           // bonus
  } else {
    addButton(false, false);          // normal
  }
});

/* Restart */
document.getElementById("restart").onclick = () => location.reload();

/* Reset leaderboard */
document.getElementById("resetLeaderboard").onclick = async () => {
  if (!db) return alert("Leaderboard offline");
  if (!confirm("Delete ALL scores?")) return;
  const snap = await db.collection("scores").get();
  const batch = db.batch();
  snap.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
  loadScores();
};

/* Load leaderboard */
loadScores();
</script>
</body>
</html>